import os
from docx import Document
from PyPDF2 import PdfReader

def get_first_line_from_docx(filepath):
    """å–å¾— Word ç¬¬ä¸€è¡Œæ–‡å­—"""
    try:
        doc = Document(filepath)
        for para in doc.paragraphs:
            text = para.text.strip()
            if text:
                return text
    except Exception as e:
        print(f"âŒ è®€å– Word æ™‚å‡ºéŒ¯ï¼š{filepath} -> {e}")
    return None


def get_first_line_from_pdf(filepath):
    """å–å¾— PDF ç¬¬ä¸€è¡Œæ–‡å­—"""
    try:
        reader = PdfReader(filepath)
        first_page = reader.pages[0]
        text = first_page.extract_text()
        if text:
            for line in text.splitlines():
                line = line.strip()
                if line:
                    return line
    except Exception as e:
        print(f"âŒ è®€å– PDF æ™‚å‡ºéŒ¯ï¼š{filepath} -> {e}")
    return None


def sanitize_filename(name):
    """ç§»é™¤ Windows ä¸å…è¨±çš„æª”åå­—å…ƒ"""
    invalid_chars = r'\/:*?"<>|'
    for ch in invalid_chars:
        name = name.replace(ch, "_")
    return name.strip()


def rename_file(filepath):
    """æ ¹æ“šæ–‡ä»¶å…§å®¹é‡æ–°å‘½å Word æˆ– PDF"""
    folder, old_name = os.path.split(filepath)
    basename, ext = os.path.splitext(old_name)
    ext = ext.lower()

    if ext == ".docx":
        first_line = get_first_line_from_docx(filepath)
    elif ext == ".pdf":
        first_line = get_first_line_from_pdf(filepath)
    else:
        print(f"âš ï¸ è·³éé docx/pdf æ–‡ä»¶: {old_name}")
        return

    if not first_line:
        print(f"âš ï¸ ç„¡æ³•å¾ {old_name} å–å¾—ç¬¬ä¸€è¡Œæ–‡å­—ï¼Œè·³éã€‚")
        return

    new_name = sanitize_filename(first_line) + ext
    new_path = os.path.join(folder, new_name)

    # è‹¥åŒåæª”å·²å­˜åœ¨ï¼Œé¿å…è¦†è“‹
    counter = 1
    while os.path.exists(new_path):
        new_path = os.path.join(folder, f"{sanitize_filename(first_line)}_{counter}{ext}")
        counter += 1

    try:
        os.rename(filepath, new_path)
        print(f"âœ… å·²é‡å‘½åï¼š{old_name} â†’ {os.path.basename(new_path)}")
    except Exception as e:
        print(f"âŒ ç„¡æ³•é‡å‘½å {old_name}ï¼š{e}")


def batch_rename(folder_path):
    """æ‰¹æ¬¡è™•ç†æ•´å€‹è³‡æ–™å¤¾"""
    for filename in os.listdir(folder_path):
        filepath = os.path.join(folder_path, filename)
        if os.path.isfile(filepath):
            rename_file(filepath)


if __name__ == "__main__":
    # ğŸŸ¢ ä¿®æ”¹é€™è£¡ï¼šè¼¸å…¥è¦è™•ç†çš„è³‡æ–™å¤¾è·¯å¾‘
    folder = r"D:\Documents\å¾…é‡å‘½å"

    if not os.path.exists(folder):
        print("âŒ è³‡æ–™å¤¾ä¸å­˜åœ¨ï¼Œè«‹ç¢ºèªè·¯å¾‘ã€‚")
    else:
        batch_rename(folder)
        print("\nğŸ‰ å…¨éƒ¨æ–‡ä»¶è™•ç†å®Œæˆï¼")

